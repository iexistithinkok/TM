<!-- File: dashboard.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Client Dashboard — Transform Multimedia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />

    <!-- Supabase bootstrap -->
    <script src="supabase-env.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>

    <!-- App logic (each once) -->
    <script src="supabase-dashboard.js" defer></script>
    <script src="supabase-projects.js" defer></script>
    <script src="supabase-project-overview.js" defer></script>
    <script src="supabase-admin-notes.js" defer></script>
    <script src="supabase-messages.js" defer></script>
    <script src="supabase-members.js" defer></script>
    <script src="supabase-files.js" defer></script>
    <script src="supabase-client-directory.js" defer></script>

    <!-- UI navigation only (this must be an external file, not inline at bottom) -->
    <script src="dashboard-ui.js" defer></script>
  </head>

  <body>
    <div class="ambient-glow"></div>
    <div class="ambient-grid tron-grid"></div>

    <header class="site-header">
      <nav class="nav">
        <a class="logo" href="index.html">
          <img class="logo-mark" src="assets/logo.png" alt="Transform Multimedia" />
          <span>Transform Multimedia</span>
        </a>

        <div style="display:flex; gap:10px; align-items:center;">
          <button class="secondary-btn" type="button" data-toggle-preview hidden>
            Preview Client View
          </button>
          <button class="secondary-btn" type="button" onclick="dashboardLogout()">Logout</button>
        </div>
      </nav>
    </header>

    <main>
      <section class="section page-hero">
        <p class="eyebrow">Dashboard</p>
        <h1>Your Project Workspace</h1>
        <div class="portal-note" data-role-indicator>Detected role: --</div>
        <div class="portal-note" data-project-indicator>Project: --</div>
      </section>

      <!-- ================= ADMIN VIEW ================= -->
      <section class="section portal" data-role="admin" hidden>
        <div class="portal-card" style="margin-bottom:16px;">
          <h2 style="margin-bottom:10px;">Admin Tools</h2>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="secondary-btn" type="button" data-tab="admin-projects">Projects</button>
            <button class="secondary-btn" type="button" data-tab="admin-members">Members</button>
            <button class="secondary-btn" type="button" data-tab="admin-notes">Updates</button>
            <button class="secondary-btn" type="button" data-tab="admin-messages">Messages</button>
            <button class="secondary-btn" type="button" data-tab="admin-files">Files</button>
          </div>

          <p class="muted" style="margin-top:10px;">
            Tip: pick an Active Project first. Everything you post applies to that project.
          </p>
        </div>

        <div class="portal-grid">
          <!-- Projects -->
          <article class="portal-card" data-panel="admin-projects">
            <h2>Projects</h2>

            <label>
              Active project
              <select data-project-select></select>
            </label>

            <form class="message-form" data-create-project-form>
              <label>
                New project name
                <input name="name" required />
              </label>
              <button class="secondary-btn" type="submit">Create Project</button>
            </form>

            <p class="muted" data-project-status></p>
          </article>

          <!-- Members -->
          <article class="portal-card" data-panel="admin-members" hidden>
            <h2>Project Members</h2>

            <label>
              Find client (email)
              <input list="client-list" data-client-search placeholder="client@email.com" />
              <datalist id="client-list" data-client-datalist></datalist>
            </label>

            <div class="message-list" data-project-members>
              <p class="muted">Select a project to load members.</p>
            </div>

            <form class="message-form" data-add-member-form>
              <label>
                User ID (UUID)
                <input name="user_id" placeholder="0b1c3313-fa9d-4cd6-b750-faeae256c07e" required />
              </label>

              <label>
                Role
                <select name="role">
                  <option value="client">client</option>
                  <option value="admin">admin</option>
                </select>
              </label>

              <button class="secondary-btn" type="submit">Add Member</button>
            </form>
          </article>

          <!-- Updates / Notes -->
          <article class="portal-card" data-panel="admin-notes" hidden>
            <h2>Project Updates</h2>
            <p class="muted">These show up for clients as announcements.</p>

            <div class="message-list" data-admin-notes>
              <p class="muted">Loading notes…</p>
            </div>

            <form class="message-form" data-admin-note-form>
              <label>
                Update
                <textarea name="note" required></textarea>
              </label>
              <button class="secondary-btn" type="submit">Post Update</button>
            </form>
          </article>

          <!-- Messages -->
          <article class="portal-card" data-panel="admin-messages" hidden>
            <h2>Project Messages</h2>
            <p class="muted">Use this for back-and-forth communication.</p>

            <div class="message-list" data-client-messages>
              <p class="muted">Loading messages…</p>
            </div>

            <form class="message-form" data-client-message-form>
              <label>
                Message
                <textarea name="client-message" required></textarea>
              </label>
              <button class="secondary-btn" type="submit">Post Message</button>
            </form>
          </article>

          <!-- Files -->
          <article class="portal-card" data-panel="admin-files" hidden>
            <h2>Deliverables & Files</h2>

            <div class="message-list" data-project-files>
              <p class="muted">Loading files…</p>
            </div>

            <form class="message-form" data-add-file-form>
              <label>Title<input name="title" required /></label>
              <label>URL<input name="url" required /></label>
              <label>
                Type
                <select name="kind">
                  <option value="link">link</option>
                  <option value="draft">draft</option>
                  <option value="final">final</option>
                  <option value="invoice">invoice</option>
                </select>
              </label>
              <button class="secondary-btn" type="submit">Add File</button>
            </form>
          </article>
        </div>
      </section>

      <!-- ================= CLIENT VIEW ================= -->
      <section class="section portal" data-role="client" hidden>
        <div class="portal-card" style="margin-bottom:16px;">
          <h2 style="margin-bottom:10px;">Client Portal</h2>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="secondary-btn" type="button" data-tab="client-overview">Overview</button>
            <button class="secondary-btn" type="button" data-tab="client-messages">Messages</button>
            <button class="secondary-btn" type="button" data-tab="client-files">Files</button>
          </div>

          <p class="muted" style="margin-top:10px;">
            Everything here is automatically filtered to your project.
          </p>
        </div>

        <!-- Overview -->
        <article class="portal-card" data-panel="client-overview">
          <h2>Latest Updates</h2>
          <div class="message-list" data-admin-notes>
            <p class="muted">Loading updates…</p>
          </div>
        </article>

        <!-- Messages -->
        <article class="portal-card" data-panel="client-messages" hidden>
          <h2>Messages</h2>
          <div class="message-list" data-client-message-feed>
            <p class="muted">Loading messages…</p>
          </div>

          <form class="message-form" data-client-send-form>
            <label>
              Send a message
              <textarea name="message" required></textarea>
            </label>
            <button class="secondary-btn" type="submit">Send</button>
          </form>
        </article>

        <!-- Files -->
        <article class="portal-card" data-panel="client-files" hidden>
          <h2>Deliverables & Files</h2>
          <div class="message-list" data-project-files>
            <p class="muted">Loading files…</p>
          </div>
        </article>
      </section>
    </main>

    <footer class="site-footer">
      <p>© Transform Multimedia</p>
    </footer>
  </body>
</html>


/* File: dashboard-ui.js */
(() => {
  const roleEl = document.querySelector("[data-role-indicator]");
  const previewBtn = document.querySelector("[data-toggle-preview]");

  const adminSection = document.querySelector('section[data-role="admin"]');
  const clientSection = document.querySelector('section[data-role="client"]');

  const showPanel = (scopeEl, panelName) => {
    if (!scopeEl) return;
    scopeEl.querySelectorAll("[data-panel]").forEach((p) => {
      p.hidden = p.getAttribute("data-panel") !== panelName;
    });
  };

  const setupTabs = (scopeEl, defaultPanel) => {
    if (!scopeEl) return;
    const buttons = scopeEl.querySelectorAll("[data-tab]");
    buttons.forEach((btn) => {
      btn.addEventListener("click", () => showPanel(scopeEl, btn.getAttribute("data-tab")));
    });
    showPanel(scopeEl, defaultPanel);
  };

  setupTabs(adminSection, "admin-projects");
  setupTabs(clientSection, "client-overview");

  const roleLooksAdmin = () => (roleEl?.textContent || "").toLowerCase().includes("admin");

  const setPreviewMode = (on) => {
    if (!adminSection || !clientSection || !previewBtn) return;
    if (on) {
      adminSection.hidden = true;
      clientSection.hidden = false;
      previewBtn.textContent = "Back to Admin View";
      setupTabs(clientSection, "client-overview");
    } else {
      adminSection.hidden = false;
      clientSection.hidden = true;
      previewBtn.textContent = "Preview Client View";
      setupTabs(adminSection, "admin-projects");
    }
  };

  const boot = () => {
    if (!previewBtn) return;
    if (!roleLooksAdmin()) return;

    previewBtn.hidden = false;
    let previewOn = false;
    previewBtn.addEventListener("click", () => {
      previewOn = !previewOn;
      setPreviewMode(previewOn);
    });
  };

  setTimeout(boot, 300);
})();


/* File: supabase-admin-notes.js  (replace with this to render into BOTH admin+client containers) */
(async () => {
  const supabase = window.supabaseClient;
  const listEls = Array.from(document.querySelectorAll("[data-admin-notes]"));
  const formEl = document.querySelector("[data-admin-note-form]");

  if (listEls.length === 0) return;

  const setAll = (msg) => {
    listEls.forEach((el) => {
      el.innerHTML = `<p class="muted">${msg}</p>`;
    });
  };

  if (!supabase?.auth?.getSession) {
    setAll("Notes unavailable (Supabase not ready).");
    return;
  }

  const { data: sessionData } = await supabase.auth.getSession();
  const session = sessionData?.session;
  if (!session) {
    window.location.href = "./portal.html";
    return;
  }

  const userId = session.user.id;

  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("user_id", userId)
    .maybeSingle();

  const role = (profile?.role || "client").toLowerCase();
  const isAdmin = role === "admin";

  const getActiveProjectId = () => {
    const raw = window.currentProjectId ?? localStorage.getItem("ACTIVE_PROJECT_ID");
    const pid = raw == null ? null : Number(raw);
    return Number.isFinite(pid) ? pid : null;
  };

  const getClientProjectId = async () => {
    const { data: memberships, error } = await supabase
      .from("project_members")
      .select("project_id")
      .eq("user_id", userId)
      .order("created_at", { ascending: true });

    if (error) {
      console.error("project_members read failed:", error);
      return null;
    }

    const pid = memberships?.[0]?.project_id ?? null;
    return Number.isFinite(Number(pid)) ? Number(pid) : null;
  };

  const render = (notes) => {
    if (!notes || notes.length === 0) {
      setAll("No updates yet.");
      return;
    }

    listEls.forEach((el) => {
      el.innerHTML = "";
      const ul = document.createElement("ul");
      ul.className = "message-thread";

      for (const n of notes) {
        const li = document.createElement("li");
        li.className = "message-item";

        const meta = document.createElement("div");
        meta.className = "message-meta";
        meta.textContent = n.created_at ? new Date(n.created_at).toLocaleString() : "";

        const body = document.createElement("div");
        body.className = "message-body";
        body.textContent = n.note ?? "";

        li.appendChild(meta);
        li.appendChild(body);
        ul.appendChild(li);
      }

      el.appendChild(ul);
    });
  };

  const load = async (projectId) => {
    if (!projectId) {
      setAll(isAdmin ? "Select a project to view updates." : "No project assigned yet.");
      return;
    }

    setAll("Loading updates…");

    const { data, error } = await supabase
      .from("admin_notes")
      .select("id, created_at, note, project_id, user_id")
      .eq("project_id", projectId)
      .order("created_at", { ascending: false })
      .limit(50);

    if (error) {
      console.error("admin_notes load failed:", error);
      setAll("Unable to load updates (check RLS).");
      return;
    }

    render(data);
  };

  const currentProjectId = isAdmin ? getActiveProjectId() : await getClientProjectId();
  await load(currentProjectId);

  window.addEventListener("project:changed", async (e) => {
    const pid = Number(e.detail?.projectId);
    if (!Number.isFinite(pid)) return;
    await load(pid);
  });

  if (isAdmin && formEl) {
    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();

      const pid = getActiveProjectId();
      if (!pid) return alert("Select an active project first.");

      const noteField = formEl.querySelector('textarea[name="note"]') || formEl.querySelector("textarea");
      const note = noteField?.value?.trim() || "";
      if (!note) return alert("Write an update first.");

      const { error } = await supabase
        .from("admin_notes")
        .insert({ project_id: pid, user_id: userId, note });

      if (error) {
        console.error("Insert note failed:", error);
        alert(error.message || "Failed to post update.");
        return;
      }

      if (noteField) noteField.value = "";
      await load(pid);
    });
  }
})();


/* File: supabase-files.js (replace with this to render into BOTH admin+client containers) */
(async () => {
  const supabase = window.supabaseClient;
  const listEls = Array.from(document.querySelectorAll("[data-project-files]"));
  const addForm = document.querySelector("[data-add-file-form]");

  if (listEls.length === 0) return;

  const setAll = (msg) => {
    listEls.forEach((el) => (el.innerHTML = `<p class="muted">${msg}</p>`));
  };

  if (!supabase?.auth?.getSession) {
    setAll("Files unavailable (Supabase not ready).");
    return;
  }

  const { data: sessionData } = await supabase.auth.getSession();
  const session = sessionData?.session;
  if (!session) {
    window.location.href = "./portal.html";
    return;
  }

  const userId = session.user.id;

  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("user_id", userId)
    .maybeSingle();

  const role = (profile?.role || "client").toLowerCase();
  const isAdmin = role === "admin";

  const getActiveProjectId = () => {
    const raw = window.currentProjectId ?? localStorage.getItem("ACTIVE_PROJECT_ID");
    const pid = raw == null ? null : Number(raw);
    return Number.isFinite(pid) ? pid : null;
  };

  const getClientProjectId = async () => {
    const { data: memberships, error } = await supabase
      .from("project_members")
      .select("project_id")
      .eq("user_id", userId)
      .order("created_at", { ascending: true });

    if (error) {
      console.error("project_members read failed:", error);
      return null;
    }

    const pid = memberships?.[0]?.project_id ?? null;
    return Number.isFinite(Number(pid)) ? Number(pid) : null;
  };

  const render = (items) => {
    if (!items || items.length === 0) {
      setAll("No files yet.");
      return;
    }

    listEls.forEach((el) => {
      el.innerHTML = "";
      const ul = document.createElement("ul");
      ul.className = "message-thread";

      for (const f of items) {
        const li = document.createElement("li");
        li.className = "message-item";

        const meta = document.createElement("div");
        meta.className = "message-meta";
        meta.textContent = `${f.kind || "link"} • ${f.created_at ? new Date(f.created_at).toLocaleString() : ""}`;

        const body = document.createElement("div");
        body.className = "message-body";

        const a = document.createElement("a");
        a.href = f.url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = f.title;

        body.appendChild(a);
        li.appendChild(meta);
        li.appendChild(body);
        ul.appendChild(li);
      }

      el.appendChild(ul);
    });
  };

  const load = async (projectId) => {
    if (!projectId) {
      setAll(isAdmin ? "Select a project to view files." : "No project assigned yet.");
      return;
    }

    setAll("Loading files…");

    const { data, error } = await supabase
      .from("project_files")
      .select("id, created_at, project_id, title, url, kind")
      .eq("project_id", projectId)
      .order("created_at", { ascending: false })
      .limit(100);

    if (error) {
      console.error("project_files load failed:", error);
      setAll("Unable to load files (check RLS).");
      return;
    }

    render(data);
  };

  const currentProjectId = isAdmin ? getActiveProjectId() : await getClientProjectId();
  await load(currentProjectId);

  window.addEventListener("project:changed", async (e) => {
    const pid = Number(e.detail?.projectId);
    if (!Number.isFinite(pid)) return;
    await load(pid);
  });

  if (isAdmin && addForm) {
    addForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const pid = getActiveProjectId();
      if (!pid) return alert("Select an active project first.");

      const title = addForm.querySelector('input[name="title"]')?.value?.trim() || "";
      const url = addForm.querySelector('input[name="url"]')?.value?.trim() || "";
      const kind = addForm.querySelector('select[name="kind"]')?.value || "link";
      if (!title || !url) return alert("Title and URL are required.");

      const { error } = await supabase
        .from("project_files")
        .insert({ project_id: pid, user_id: userId, title, url, kind });

      if (error) {
        console.error("Insert file failed:", error);
        alert(error.message || "Failed to add file.");
        return;
      }

      addForm.reset();
      await load(pid);
    });
  }
})();


/* File: supabase-messages.js (replace with this to support client send form + admin preview) */
(async () => {
  const supabase = window.supabaseClient;

  const clientFeedEl = document.querySelector("[data-client-message-feed]");
  const adminFeedEl = document.querySelector("[data-client-messages]");

  const adminFormEl = document.querySelector("[data-client-message-form]");
  const adminTextArea =
    adminFormEl?.querySelector('textarea[name="client-message"]') || adminFormEl?.querySelector("textarea");

  const clientSendFormEl = document.querySelector("[data-client-send-form]");
  const clientSendTextArea =
    clientSendFormEl?.querySelector('textarea[name="message"]') || clientSendFormEl?.querySelector("textarea");

  const setFeedMessage = (el, msg) => {
    if (!el) return;
    el.innerHTML = `<p class="muted">${msg}</p>`;
  };

  if (!clientFeedEl && !adminFeedEl) return;

  if (!supabase?.auth?.getSession) {
    setFeedMessage(clientFeedEl, "Messages unavailable (Supabase not ready).");
    setFeedMessage(adminFeedEl, "Messages unavailable (Supabase not ready).");
    return;
  }

  const { data: sessionData } = await supabase.auth.getSession();
  const session = sessionData?.session;
  if (!session) {
    window.location.href = "./portal.html";
    return;
  }

  const userId = session.user.id;

  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("user_id", userId)
    .maybeSingle();

  const role = (profile?.role || "client").toLowerCase();
  const isAdmin = role === "admin";

  const getActiveProjectIdForAdmin = () => {
    const raw = window.currentProjectId ?? localStorage.getItem("ACTIVE_PROJECT_ID");
    const pid = raw == null ? null : Number(raw);
    return Number.isFinite(pid) ? pid : null;
  };

  const getClientProjectId = async () => {
    const { data: memberships, error } = await supabase
      .from("project_members")
      .select("project_id")
      .eq("user_id", userId)
      .order("created_at", { ascending: true });

    if (error) {
      console.error("Failed to load project membership:", error);
      return null;
    }

    const pid = memberships?.[0]?.project_id ?? null;
    return Number.isFinite(Number(pid)) ? Number(pid) : null;
  };

  const renderMessages = (el, messages) => {
    if (!el) return;
    if (!messages || messages.length === 0) return setFeedMessage(el, "No messages yet.");

    el.innerHTML = "";
    const ul = document.createElement("ul");
    ul.className = "message-thread";

    for (const m of messages) {
      const li = document.createElement("li");
      li.className = "message-item";

      const meta = document.createElement("div");
      meta.className = "message-meta";
      meta.textContent = m.created_at ? new Date(m.created_at).toLocaleString() : "";

      const body = document.createElement("div");
      body.className = "message-body";
      body.textContent = m.message ?? "";

      li.appendChild(meta);
      li.appendChild(body);
      ul.appendChild(li);
    }

    el.appendChild(ul);
  };

  const fetchMessages = async (projectId) => {
    const targetEl = isAdmin ? adminFeedEl : clientFeedEl;
    setFeedMessage(targetEl, "Loading messages…");

    const { data: messages, error } = await supabase
      .from("project_messages")
      .select("id, created_at, user_id, project_id, message")
      .eq("project_id", projectId)
      .order("created_at", { ascending: false })
      .limit(50);

    if (error) {
      console.error("Failed to load messages:", error);
      setFeedMessage(targetEl, "Unable to load messages (check RLS).");
      return;
    }

    // Admin preview mode: also render into the client feed if it exists
    if (isAdmin) {
      renderMessages(adminFeedEl, messages);
      if (clientFeedEl) renderMessages(clientFeedEl, messages);
      return;
    }

    renderMessages(clientFeedEl, messages);
  };

  if (isAdmin) {
    const projectId = getActiveProjectIdForAdmin();
    if (!projectId) {
      setFeedMessage(adminFeedEl, "Select a project to view messages.");
    } else {
      await fetchMessages(projectId);
    }

    window.addEventListener("project:changed", async (e) => {
      const pid = Number(e.detail?.projectId);
      if (!Number.isFinite(pid)) return;
      await fetchMessages(pid);
    });

    if (adminFormEl) {
      adminFormEl.addEventListener("submit", async (e) => {
        e.preventDefault();

        const pid = getActiveProjectIdForAdmin();
        if (!pid) return alert("Select an active project first.");

        const text = adminTextArea?.value?.trim() || "";
        if (!text) return alert("Write a message first.");

        const { error } = await supabase
          .from("project_messages")
          .insert({ project_id: pid, user_id: userId, message: text });

        if (error) return alert(error.message || "Failed to post message.");

        if (adminTextArea) adminTextArea.value = "";
        await fetchMessages(pid);
      });
    }

    return;
  }

  // Client view
  const projectId = await getClientProjectId();
  if (!projectId) {
    setFeedMessage(clientFeedEl, "No project assigned yet.");
    return;
  }

  await fetchMessages(projectId);

  if (clientSendFormEl) {
    clientSendFormEl.addEventListener("submit", async (e) => {
      e.preventDefault();

      const text = clientSendTextArea?.value?.trim() || "";
      if (!text) return;

      const { error } = await supabase
        .from("project_messages")
        .insert({ project_id: projectId, user_id: userId, message: text });

      if (error) return alert(error.message || "Failed to send message.");

      if (clientSendTextArea) clientSendTextArea.value = "";
      await fetchMessages(projectId);
    });
  }
})();
